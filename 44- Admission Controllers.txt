Admission Controllers

En Kubernetes, les Admission Controllers (ou contrÃ´leurs dâ€™admission) sont des
composants critiques de la sÃ©curitÃ© et de la validation dans le cycle de vie
dâ€™une requÃªte API.
Ils interviennent aprÃ¨s lâ€™authentification et lâ€™autorisation, mais avant que
lâ€™objet ne soit stockÃ© dans etcd.

Un Admission Controller peut :
- Modifier les objets de requÃªte (ex. : ajout automatique de labels, sidecars, ressources).
- Valider ou rejeter les requÃªtes selon des rÃ¨gles (ex. : refuser les containers qui s'exÃ©cutent en tant que root).
- Appliquer des politiques de sÃ©curitÃ© ou de fonctionnement (ex. : quotas, PSP, OPA/Gatekeeperâ€¦).

Utilisateur -> API Server
      â†³ Authentification
      â†³ Autorisation (RBAC, ABACâ€¦)
      â†³ Admission Controllers (validation ou mutation)
      â†³ PersistÃ© dans etcd (si acceptÃ©)

Il en existe deux types principaux :
1- Mutating Admission Controllers
â†’ Peuvent modifier les objets (ex. : MutatingAdmissionWebhook, DefaultStorageClass).
2- Validating Admission Controllers
â†’ Peuvent rejeter les objets (ex. : ValidatingAdmissionWebhook, PodSecurityPolicy, ResourceQuota).
ðŸ‘‰ Un objet passe dâ€™abord par les mutateurs, puis par les validateurs.

Webhooks dâ€™admission (dynamiques)
Il est possible d'Ã©crire des webhooks personnalisÃ©s :

MutatingAdmissionWebhook : pour modifier dynamiquement les objets.
ValidatingAdmissionWebhook : pour appliquer des rÃ¨gles mÃ©tier/custom.
Ces webhooks sont externes Ã  l'API server mais appelÃ©s Ã  chaque crÃ©ation/modification d'objet.

| Admission Controller         | RÃ´le principal                                     |
| ---------------------------- | -------------------------------------------------- |
| `NamespaceLifecycle`         | EmpÃªche dâ€™agir sur les namespaces en suppression   |
| `LimitRanger`                | Applique des limites de ressources (CPU, mÃ©moireâ€¦) |
| `ServiceAccount`             | Attache automatiquement un service account         |
| `DefaultStorageClass`        | Ajoute une classe de stockage par dÃ©faut           |
| `ResourceQuota`              | Applique les quotas par namespace                  |
| `PodSecurity`                | Applique les politiques de sÃ©curitÃ© des pods (PSA) |
| `MutatingAdmissionWebhook`   | Appelle les webhooks de mutation                   |
| `ValidatingAdmissionWebhook` | Appelle les webhooks de validation                 |

Les Admission Controllers sont activÃ©s dans le fichier de configuration de lâ€™API Server (--enable-admission-plugins).
--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,PodSecurity,...

Cas dâ€™usage courant
Bloquer la crÃ©ation de pods qui montent des volumes hostPath.
Forcer lâ€™usage dâ€™une image registry interne.
Injecter un sidecar (ex. Istio, Linkerd).
Appliquer les Pod Security Admission (PSA) : restricted, baseline, privileged.

-- Lister les admission controllers activÃ©s (en dehors de ceux qui le sont automatiquement)
grep enable-admission-plugins /etc/kubernetes/manifests/kube-apiserver.yaml

-- Lister les admission-plugins (enable et disable)
ps -ef | grep kube-apiserver | grep admission-plugins
