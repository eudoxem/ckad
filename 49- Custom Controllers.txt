Custom Controllers

Un custom controller dans Kubernetes est un programme qui surveille lâ€™Ã©tat de vos
objets (custom ou natifs) et agit pour rapprocher lâ€™Ã©tat actuel de lâ€™Ã©tat dÃ©sirÃ© â€”
câ€™est le cÅ“ur du pattern â€œcontroller/operatorâ€.

ğŸ§  Quâ€™est-ce quâ€™un custom controller ?
Un controller :
Observe lâ€™Ã©tat du cluster via lâ€™API Kubernetes.
Compare cet Ã©tat Ã  celui souhaitÃ© (dÃ©fini par un manifest YAML, souvent via une Custom Resource).
Prend des actions correctives pour faire correspondre lâ€™Ã©tat rÃ©el Ã  lâ€™Ã©tat dÃ©sirÃ©.
Un custom controller est souvent couplÃ© avec une Custom Resource Definition (CRD), mais ce nâ€™est pas obligatoire.

ğŸ— Exemple simple : controller pour MyApp
1. CRD de MyApp (dÃ©jÃ  vue) :
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: myapps.example.com
spec:
  group: example.com
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                replicas:
                  type: integer
  scope: Namespaced
  names:
    plural: myapps
    singular: myapp
    kind: MyApp

2. Custom Resource :
apiVersion: example.com/v1
kind: MyApp
metadata:
  name: demo
spec:
  replicas: 2

3. Custom Controller (en Go, pseudo-code simplifiÃ©) :
func reconcile(myApp *MyApp) {
    // Lire l'Ã©tat actuel : combien de pods sont crÃ©Ã©s
    currentPods := listPodsWithLabel("app", myApp.Name)

    // Lire le nombre dÃ©sirÃ©
    desired := myApp.Spec.Replicas

    if len(currentPods) < desired {
        // CrÃ©er des pods
        for i := len(currentPods); i < desired; i++ {
            createPodForMyApp(myApp)
        }
    } else if len(currentPods) > desired {
        // Supprimer l'excÃ©dent
        for i := desired; i < len(currentPods); i++ {
            deletePod(currentPods[i])
        }
    }
}
En rÃ©alitÃ©, on utilise souvent Kubebuilder ou Operator SDK pour gÃ©nÃ©rer ce code proprement.
ğŸ› ï¸ Outils pour crÃ©er un controller

Outil	Description
Kubebuilder	Le plus populaire, maintenu par la communautÃ© Kubernetes
Operator SDK	Plus orientÃ© â€œOperatorsâ€ (intÃ©gration Ansible/Helm)
client-go	La librairie officielle en Go pour parler Ã  lâ€™API Kubernetes

ğŸ” Boucle de Reconciliation
Un controller agit en boucle :

ReÃ§oit un Ã©vÃ©nement (changement sur un objet).
Lit lâ€™Ã©tat actuel.
Calcule lâ€™Ã©cart avec lâ€™Ã©tat dÃ©sirÃ©.
Applique les actions nÃ©cessaires.
Ce modÃ¨le est idempotent : on peut exÃ©cuter reconcile() plusieurs fois sans effet secondaire.
